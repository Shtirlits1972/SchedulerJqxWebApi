import{d as W,g as G,u as H,r as y,s as F,b as K,e as Q,f as X,c as E,a as d,h as Y,i as Z,t as z,j as R,w as ee,k as te,v as ae,o as L,_ as oe}from"./index-bgLIQOvD.js";import{j as ne,a as ie,J as se,b as le}from"./jqxLocalization-BPQ3dxrd.js";const re={class:"page"},de={key:0,class:"page__error"},ue={key:1,class:"page__note"},ce={class:"modal"},fe={class:"modal__field"},pe=["disabled"],ve={class:"modal__actions"},me=["disabled"],ye=["disabled"],we=W({__name:"LocationsPage",setup(he){const _=`${G().replace(/\/$/,"")}/api/Location`,$=H(),l=y(null),b=F(null),o=y(""),v=y(!1),n=y(null),u=y(!1),f=y(null),i=K({id:null,nameLocation:""}),p=Q(()=>$.token.value??""),A={datatype:"array",datafields:[{name:"id",type:"number"},{name:"nameLocation",type:"string"}],id:"id",localdata:[]},C=[{text:"ID",datafield:"id",width:90,cellsalign:"center",align:"center",editable:!1,filtertype:"number"},{text:"Название",datafield:"nameLocation",editable:!0,filtertype:"input",filtercondition:"starts_with"}],k=()=>{if(b.value)return b.value;const t=typeof window<"u"?window.jqx:void 0;return t?.dataAdapter?(b.value=new t.dataAdapter(A,{autoBind:!0}),b.value):(o.value="Не удалось инициализировать jqxGrid. Проверьте, что скрипты jqxcore и jqxgrid подключены в main.ts.",null)},I=()=>{l.value&&typeof l.value.updatebounddata=="function"&&l.value.updatebounddata("cells")},w=async()=>{if(o.value="",v.value=!0,n.value=null,g(),$.dropExpiredToken(),!p.value){o.value="Необходима авторизация для загрузки локаций.",v.value=!1;return}try{const t=await fetch(_,{headers:{Accept:"application/json",Authorization:`Bearer ${p.value}`}});if(!t.ok)throw new Error(`${t.status} ${t.statusText}`.trim());const e=await t.json();A.localdata=Array.isArray(e)?e:[];const a=k();a&&(typeof a.dataBind=="function"&&a.dataBind(),I())}catch(t){console.error("[locations] load failed",t),o.value=t instanceof Error?`Не удалось загрузить локации: ${t.message}`:"Не удалось загрузить локации"}finally{v.value=!1}};X(()=>{k(),w()});const r={},g=()=>{const t=!!n.value;r.edit&&(r.edit.disabled=!t),r.remove&&(r.remove.disabled=!t)},q=t=>{const e=t?.args&&t.args.row;e&&typeof e.id<"u"?n.value={id:Number(e.id),nameLocation:String(e.nameLocation??"")}:n.value=null,g()},N=async()=>{if(!(!n.value||!(!(typeof window<"u")||window.confirm(`Удалить локацию "${n.value.nameLocation}"?`)))){o.value="",v.value=!0;try{const e=await fetch(`${_}/${n.value.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${p.value}`}});if(!e.ok)throw new Error(`${e.status} ${e.statusText}`.trim());n.value=null,g(),await w()}catch(e){console.error("[locations] remove failed",e),o.value=e instanceof Error?`Не удалось удалить локацию: ${e.message}`:"Не удалось удалить локацию"}finally{v.value=!1}}},P=async t=>{if(!p.value)return o.value="Необходима авторизация для редактирования.",!1;const e=t?.args??{};if(e.datafield!=="nameLocation")return!0;const a=e.rowindex;if(typeof a!="number"||Number.isNaN(a))return o.value="Не удалось определить строку для редактирования.",!1;const x=String(e.value??"").trim(),c=String(e.oldvalue??"").trim();if(x===c)return!0;const m=(typeof l.value?.getrowid=="function"?l.value.getrowid(a):void 0)??n.value?.id??null;if(m==null)return o.value="Не удалось определить ID строки.",!1;u.value=!0;try{const s=await fetch(_,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p.value}`},body:JSON.stringify({id:m,nameLocation:x})});if(!s.ok)throw new Error(`${s.status} ${s.statusText}`.trim());return await w(),!0}catch(s){return console.error("[locations] inline edit failed",s),o.value=s instanceof Error?`Не удалось сохранить локацию: ${s.message}`:"Не удалось сохранить локацию",typeof l.value?.setcellvalue=="function"&&l.value.setcellvalue(a,"nameLocation",c),!1}finally{u.value=!1}},U=()=>{o.value="",i.id=null,i.nameLocation="",typeof f.value?.open=="function"&&f.value.open()},D=()=>{n.value&&(o.value="",i.id=n.value.id,i.nameLocation=n.value.nameLocation,typeof f.value?.open=="function"&&f.value.open())},S=()=>{typeof f.value?.close=="function"&&f.value.close()},M=async()=>{if(o.value="",!p.value){o.value="Необходима авторизация для добавления локации.";return}const t=i.nameLocation.trim();if(!t){o.value="Название локации обязательно.";return}u.value=!0;try{const e=i.id!==null&&i.id!==void 0,a=await fetch(_,{method:e?"PUT":"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p.value}`},body:JSON.stringify({id:e?i.id:0,nameLocation:t})});if(!a.ok)throw new Error(`${a.status} ${a.statusText}`.trim());S(),await w()}catch(e){console.error("[locations] save failed",e),o.value=e instanceof Error?`Не удалось сохранить локацию: ${e.message}`:"Не удалось сохранить локацию"}finally{u.value=!1}},J=t=>{const e=t?.[0]??t?.element??t;if(!e)return;typeof t?.empty=="function"?t.empty():typeof e=="object"&&"innerHTML"in e&&(e.innerHTML="");const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.gap="8px",a.style.padding="6px 8px",a.style.boxSizing="border-box";const x={height:"32px",width:"140px",padding:"0 10px",borderRadius:"8px",border:"1px solid #e2e8f0",background:"#0f172a",color:"#ffffff",cursor:"pointer",fontWeight:"700",fontSize:"13px"},c=(O,V)=>{const h=document.createElement("button");return h.type="button",h.textContent=O,Object.assign(h.style,x),h.addEventListener("click",V),h},B=c("Добавить",()=>{U()}),m=c("Редактировать",()=>{D()}),s=c("Удалить",()=>{N()}),T=c("Обновить",()=>{w()}),j=c("Сбросить фильтры",()=>{l.value?.clearfilters?.()});r.add=B,r.edit=m,r.remove=s,r.refresh=T,r.reset=j,g(),a.append(B,m,s,T,j),typeof t?.append=="function"?t.append(a):typeof e?.appendChild=="function"&&e.appendChild(a)};return(t,e)=>(L(),E("section",re,[e[3]||(e[3]=d("p",{class:"page__title"},"Локации",-1)),o.value?(L(),E("p",de,z(o.value),1)):v.value?(L(),E("p",ue,"Загружаем локации…")):(L(),Y(se,{key:2,ref_key:"gridRef",ref:l,width:"100%",source:k(),columns:C,autoheight:!0,sortable:!0,filterable:!0,pageable:!0,pagesizeoptions:["5","10","20","50","100"],pagesize:10,localization:R(ie),locale:R(ne),autoshowfiltericon:!1,showtoolbar:!0,toolbarheight:44,rendertoolbar:J,altrows:!0,selectionmode:"singlerow",columnsresize:!0,enablebrowserselection:!0,editable:!0,editmode:"dblclick",onRowselect:q,onCellendedit:P},null,8,["source","localization","locale"])),Z(le,{ref_key:"windowRef",ref:f,width:360,height:200,isModal:!0,autoOpen:!1,resizable:!1},{default:ee(()=>[e[2]||(e[2]=d("div",null,"локация",-1)),d("div",ce,[d("label",fe,[e[1]||(e[1]=d("span",{class:"modal__label"},"Название",-1)),te(d("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>i.nameLocation=a),class:"modal__input",type:"text",placeholder:"Введите название",disabled:u.value,required:""},null,8,pe),[[ae,i.nameLocation]])]),d("div",ve,[d("button",{class:"modal__button modal__button--ghost",type:"button",onClick:S,disabled:u.value}," Отмена ",8,me),d("button",{class:"modal__button",type:"button",onClick:M,disabled:u.value},z(u.value?"Сохраняем...":"Сохранить"),9,ye)])])]),_:1},512)]))}}),xe=oe(we,[["__scopeId","data-v-79910a51"]]);export{xe as default};
