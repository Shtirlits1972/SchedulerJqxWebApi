import{d as te,g as ae,u as se,e as w,s as le,f as oe,h as R,o as re,c as U,m as l,i as ie,k as ne,t as q,l as L,w as de,p as h,v as I,q as D,x as ue,b as $,_ as pe}from"./index-Boo3TOTd.js";import{J as ce}from"./vue_jqxgrid-qvox2DuS.js";import{a as fe,j as me,J as ve}from"./jqxLocalization-CaCPw_HT.js";const be={class:"page"},we={key:0,class:"page__error"},_e={key:1,class:"page__note"},ye={class:"modal"},ge={class:"modal__field"},he=["disabled"],xe={class:"modal__field"},Ae=["disabled"],Ne={class:"modal__field"},ke=["disabled"],Ee={class:"modal__field"},Se={class:"modal__radios"},$e={class:"modal__radio"},Be=["disabled"],Te={class:"modal__radio"},je=["disabled"],Re={class:"modal__checkbox"},Ue=["disabled"],qe={class:"modal__actions"},Ie=["disabled"],ze=["disabled"],Ce=te({__name:"UsersPage",setup(Le){const x=`${ae().replace(/\/$/,"")}/api/Users`,A=se(),v=w(null),S=le(null),r=w(""),N=w(!1),B=w(!1),p=w(!1),_=w(null),i=w(null),y=w(null),s=oe({email:"",password:"",usersName:"",role:"user",isAppruved:!1}),b=R(()=>A.token.value??""),P=R(()=>N.value||B.value||p.value),M=R(()=>_.value!==null?"Редактирование пользователя":"Новый пользователь"),T={datatype:"array",datafields:[{name:"id",type:"number"},{name:"email",type:"string"},{name:"password",type:"string"},{name:"role",type:"string"},{name:"usersName",type:"string"},{name:"isAppruved",type:"bool"}],id:"id",localdata:[]},J=[{text:"ID",datafield:"id",width:80,cellsalign:"center",align:"center",filtertype:"number",editable:!1},{text:"Имя",datafield:"usersName",filtertype:"input",filtercondition:"starts_with",editable:!0},{text:"Email",datafield:"email",width:200,filtertype:"input",filtercondition:"contains",editable:!0},{text:"Пароль",datafield:"password",width:160,filtertype:"input",filtercondition:"contains",editable:!0},{text:"Роль",datafield:"role",width:120,align:"center",cellsalign:"center",filtertype:"checkedlist",columntype:"dropdownlist",editable:!0,createeditor:(t,e,a)=>{const o=["user","admin"];a?.jqxDropDownList?.({source:o,autoDropDownHeight:!0,selectedIndex:Math.max(o.indexOf(e),0)})}},{text:"Подтвержден",datafield:"isAppruved",width:150,cellsalign:"center",align:"center",columntype:"checkbox",filtertype:"checkedlist",editable:!0}],j=()=>{if(S.value)return S.value;const t=typeof window<"u"?window.jqx:void 0;return t?.dataAdapter?(S.value=new t.dataAdapter(T,{autoBind:!0}),S.value):(r.value="Не удалось инициализировать jqxGrid. Проверьте, что скрипты jqxcore и jqxgrid подключены в main.ts.",null)},O=()=>{v.value&&typeof v.value.updatebounddata=="function"&&v.value.updatebounddata("cells")},u={},m=()=>{const t=!!i.value,e=P.value;u.add&&(u.add.disabled=e),u.refresh&&(u.refresh.disabled=e),u.reset&&(u.reset.disabled=e),u.edit&&(u.edit.disabled=e||!t),u.remove&&(u.remove.disabled=e||!t)},k=async()=>{if(r.value="",N.value=!0,i.value=null,m(),A.dropExpiredToken(),!b.value){r.value="Необходима авторизация для загрузки пользователей.",N.value=!1;return}try{const t=await fetch(x,{headers:{Accept:"application/json",Authorization:`Bearer ${b.value}`}});if(!t.ok)throw new Error(`${t.status} ${t.statusText}`.trim());const e=await t.json();T.localdata=Array.isArray(e)?e.map(o=>({id:Number(o.id??0),email:String(o.email??""),password:String(o.password??""),role:String(o.role??""),usersName:String(o.usersName??""),isAppruved:!!o.isAppruved})):[];const a=j();a&&(a.dataBind?.(),O())}catch(t){console.error("[users] load failed",t),r.value=t instanceof Error?`Не удалось загрузить пользователей: ${t.message}`:"Не удалось загрузить пользователей"}finally{N.value=!1,m()}};re(()=>{j(),k()});const V=t=>{const e=t?.args&&t.args.row;e&&typeof e.id<"u"?i.value={id:Number(e.id),email:String(e.email??""),password:String(e.password??""),role:String(e.role??""),usersName:String(e.usersName??""),isAppruved:!!e.isAppruved}:i.value=null,m()},W=(t,e,a,o)=>{const n=typeof v.value?.getrowid=="function"?v.value.getrowid(t):i.value?.id,f=Number(n??0),g=o||T.localdata.find(c=>Number(c.id)===f)||(i.value&&Number(i.value.id)===f?i.value:null),d={id:f,email:"",password:"",role:"user",usersName:"",isAppruved:!1,...g??{}};switch(e){case"email":d.email=String(a??"").trim();break;case"password":d.password=String(a??"").trim();break;case"usersName":d.usersName=String(a??"").trim();break;case"role":{const c=String(a??"").trim();d.role=c==="admin"?"admin":"user";break}case"isAppruved":d.isAppruved=!!a;break}return d},F=async t=>{const e=t?.args??{},a=String(e.datafield??"");if(!["email","password","usersName","role","isAppruved"].includes(a))return!0;const n=e.rowindex;if(typeof n!="number"||Number.isNaN(n))return r.value="Не удалось определить строку для редактирования.",!1;const f=e.value,g=e.oldvalue;if(f===g)return!0;if(A.dropExpiredToken(),!b.value)return r.value="Необходима авторизация для редактирования.",!1;const d=W(n,a,f,e.row);if(!d||d.id===void 0||d.id===null||Number.isNaN(Number(d.id)))return r.value="Не удалось определить ID пользователя.",!1;p.value=!0,m();try{const c=await fetch(`${x}/${d.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b.value}`},body:JSON.stringify(d)});if(!c.ok)throw new Error(`${c.status} ${c.statusText}`.trim());return await k(),!0}catch(c){return console.error("[users] inline edit failed",c),r.value=c instanceof Error?`Не удалось сохранить пользователя: ${c.message}`:"Не удалось сохранить пользователя",typeof v.value?.setcellvalue=="function"&&v.value.setcellvalue(n,a,g),!1}finally{p.value=!1,m()}},G=async()=>{if(i.value&&!(typeof window<"u"&&!window.confirm(`Удалить пользователя "${i.value.usersName}"?`))){if(r.value="",A.dropExpiredToken(),!b.value){r.value="Необходима авторизация для удаления.";return}B.value=!0,m();try{const t=await fetch(`${x}/${i.value.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${b.value}`}});if(!t.ok)throw new Error(`${t.status} ${t.statusText}`.trim());i.value=null,m(),await k()}catch(t){console.error("[users] remove failed",t),r.value=t instanceof Error?`Не удалось удалить пользователя: ${t.message}`:"Не удалось удалить пользователя"}finally{B.value=!1,m()}}},H=()=>{s.email="",s.password="",s.usersName="",s.role="user",s.isAppruved=!1},K=()=>{r.value="",_.value=null,H(),typeof y.value?.open=="function"&&y.value.open()},Q=()=>{i.value&&(r.value="",_.value=i.value.id,s.email=i.value.email,s.password=i.value.password,s.usersName=i.value.usersName,s.role=i.value.role||"user",s.isAppruved=i.value.isAppruved,typeof y.value?.open=="function"&&y.value.open())},z=()=>{_.value=null,typeof y.value?.close=="function"&&y.value.close()},X=async()=>{if(r.value="",A.dropExpiredToken(),!b.value){r.value="Необходима авторизация для добавления.";return}const t=s.email.trim(),e=s.password.trim(),a=s.usersName.trim();if(!t||!e||!a){r.value="Заполните Email, Пароль и Имя пользователя.";return}p.value=!0,m();try{const o=_.value!==null,n=_.value??0,f=await fetch(o?`${x}/${n}`:x,{method:o?"PUT":"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b.value}`},body:JSON.stringify({id:n,email:t,password:e,usersName:a,role:s.role,isAppruved:s.isAppruved})});if(!f.ok)throw new Error(`${f.status} ${f.statusText}`.trim());_.value=null,z(),await k()}catch(o){console.error("[users] save failed",o),r.value=o instanceof Error?`Не удалось добавить пользователя: ${o.message}`:"Не удалось добавить пользователя"}finally{p.value=!1,m()}},Y=t=>{const e=t?.[0]??t?.element??t;if(!e)return;typeof t?.empty=="function"?t.empty():typeof e=="object"&&"innerHTML"in e&&(e.innerHTML="");const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.gap="8px",a.style.padding="6px 8px",a.style.boxSizing="border-box";const o={height:"32px",minWidth:"140px",padding:"0 10px",borderRadius:"8px",border:"1px solid #e2e8f0",background:"#0f172a",color:"#ffffff",cursor:"pointer",fontWeight:"700",fontSize:"13px"},n=(Z,ee)=>{const E=document.createElement("button");return E.type="button",E.textContent=Z,Object.assign(E.style,o),E.addEventListener("click",ee),E},f=n("Добавить",()=>{K()}),g=n("Редактировать",()=>{Q()}),d=n("Удалить",()=>{G()}),c=n("Обновить",()=>{k()}),C=n("Сбросить фильтры",()=>{v.value?.clearfilters?.()});u.add=f,u.edit=g,u.remove=d,u.refresh=c,u.reset=C,m(),a.append(f,g,d,c,C),typeof t?.append=="function"?t.append(a):typeof e?.appendChild=="function"&&e.appendChild(a)};return(t,e)=>($(),U("section",be,[e[13]||(e[13]=l("p",{class:"page__title"},"Пользователи",-1)),r.value?($(),U("p",we,q(r.value),1)):N.value?($(),U("p",_e,"Загружаем пользователей...")):($(),ie(ce,{key:2,ref_key:"gridRef",ref:v,width:"100%",source:j(),columns:J,autoheight:!0,sortable:!0,filterable:!0,autoshowfiltericon:!1,localization:L(me),locale:L(fe),pageable:!0,pagesizeoptions:["5","10","20","50","100"],pagesize:10,showtoolbar:!0,toolbarheight:44,rendertoolbar:Y,altrows:!0,columnsresize:!0,enablebrowserselection:!0,selectionmode:"singlerow",editable:!0,editmode:"dblclick",onRowselect:V,onCellendedit:F},null,8,["source","localization","locale"])),ne(ve,{ref_key:"windowRef",ref:y,width:420,height:420,isModal:!0,autoOpen:!1,resizable:!1},{default:de(()=>[l("div",null,q(M.value),1),l("div",ye,[l("label",ge,[e[6]||(e[6]=l("span",{class:"modal__label"},"Имя",-1)),h(l("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>s.usersName=a),class:"modal__input",type:"text",placeholder:"Ф.И.О. пользователя",disabled:p.value,required:""},null,8,he),[[I,s.usersName]])]),l("label",xe,[e[7]||(e[7]=l("span",{class:"modal__label"},"Email",-1)),h(l("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>s.email=a),class:"modal__input",type:"email",placeholder:"user@example.com",disabled:p.value,required:""},null,8,Ae),[[I,s.email]])]),l("label",Ne,[e[8]||(e[8]=l("span",{class:"modal__label"},"Пароль",-1)),h(l("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>s.password=a),class:"modal__input",type:"text",placeholder:"Введите пароль",disabled:p.value,required:""},null,8,ke),[[I,s.password]])]),l("fieldset",Ee,[e[11]||(e[11]=l("span",{class:"modal__label"},"Роль",-1)),l("div",Se,[l("label",$e,[h(l("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>s.role=a),type:"radio",name:"user-role",value:"user",disabled:p.value},null,8,Be),[[D,s.role]]),e[9]||(e[9]=l("span",null,"Пользователь",-1))]),l("label",Te,[h(l("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>s.role=a),type:"radio",name:"user-role",value:"admin",disabled:p.value},null,8,je),[[D,s.role]]),e[10]||(e[10]=l("span",null,"Админ",-1))])])]),l("label",Re,[h(l("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>s.isAppruved=a),type:"checkbox",disabled:p.value},null,8,Ue),[[ue,s.isAppruved]]),e[12]||(e[12]=l("span",null,"Подтвержден",-1))]),l("div",qe,[l("button",{class:"modal__button modal__button--ghost",type:"button",onClick:z,disabled:p.value}," Отмена ",8,Ie),l("button",{class:"modal__button",type:"button",onClick:X,disabled:p.value},q(p.value?"Сохраняем...":"Сохранить"),9,ze)])])]),_:1},512)]))}}),Oe=pe(Ce,[["__scopeId","data-v-ab12fa2d"]]);export{Oe as default};
